# FIT Running Data Analyzer v1.7.0 Release Notes

**发布日期**: 2026-01-19  
**版本号**: 1.7.0  
**类型**: 功能增强

---

## 📋 版本概述

v1.7.0 是一个重要的功能增强版本，主要改进了字段选择器的用户体验。本版本为单圈数据表格添加了可定制的字段选择功能，并对趋势图和单圈数据的字段选择器进行了统一的分组重构，支持字段分组、展开/折叠、全选/全不选等高级交互，并实现了选择持久化。

---

## ✨ 新增功能

### 1. 单圈数据字段选择器
- **功能描述**: 用户可以自定义单圈表格显示的列，不再固定为9列
- **默认选择**: 圈号、时间、距离、配速、平均心率（5个核心字段）
- **用户价值**: 
  - 避免列过多或过少的问题
  - 根据个人需求定制显示内容
  - 支持IQ扩展字段显示

### 2. 字段分组显示
- **功能描述**: 所有字段按语义分组（心率、步频、功率、龙豆功率、龙豆冲击力等）
- **分组列表**:
  - **标准字段**: 基础数据、配速、心率、步频、功率、海拔/爬升、环境、跑步动态、热量
  - **IQ字段**: 龙豆功率、龙豆冲击力、龙豆动态、龙豆其他、导入数据、未分类
- **用户价值**: 
  - 提高字段查找效率
  - 相关字段（如avg/max）聚合显示
  - 自动归类未知IQ字段

### 3. 分组展开/折叠
- **功能描述**: 支持点击分组标题展开/折叠，支持"展开/折叠全部"快捷按钮
- **默认状态**: 所有分组默认展开
- **用户价值**: 
  - 减少视觉干扰
  - 快速定位所需字段组
  - 灵活控制显示密度

### 4. 全选/全不选按钮
- **功能描述**: 一键全选或全不选所有可见字段
- **用户价值**: 
  - 快速批量选择
  - 避免逐个点击

### 5. 字段选择持久化
- **功能描述**: 用户的字段选择自动保存到localStorage，下次打开自动恢复
- **持久化范围**:
  - 趋势图字段选择 (`trend_selected_fields`)
  - 单圈表格字段选择 (`lap_selected_fields`)
- **用户价值**: 
  - 避免每次重新选择
  - 保持个性化配置

### 6. 自动空值过滤
- **功能描述**: 100%为空的字段自动隐藏，不在选择器中显示
- **过滤逻辑**: 所有数据点都为null/undefined的字段被过滤
- **用户价值**: 
  - 避免无意义字段干扰
  - 简化选择器界面

### 7. 相对时间显示
- **功能描述**: 单圈的start_time显示为相对第一圈的时间（+MM:SS格式）
- **示例**: 第一圈显示+0:00，第二圈显示+5:45
- **用户价值**: 
  - 更直观的圈间时间差
  - 便于分析配速变化

---

## 🔧 技术改进

### 前端改进
1. **charts.js**:
   - 新增localStorage工具函数（`saveFieldSelection`, `loadFieldSelection`）
   - 定义统一字段分组配置（`FIELD_GROUPS`, `LAP_FIELD_GROUPS`）
   - 重构`renderUnifiedFieldSelector()`支持分组、控制按钮
   - 更新`renderFieldSelector()`支持分组和持久化
   - 重构`renderLapsTable()`为动态列渲染

2. **app.js**:
   - 新增`extractAvailableLapFields()`字段提取和过滤函数
   - 新增`renderLapFieldSelector()`单圈选择器渲染函数
   - 新增`formatRelativeTime()`相对时间格式化函数

3. **index.html**:
   - 单圈表格上方添加字段选择器容器

4. **styles.css**:
   - 新增字段选择器控制按钮样式
   - 新增可折叠分组样式
   - 新增展开/折叠动画效果

### 代码质量
- ✅ 统一字段分组配置，减少重复代码
- ✅ 完整的字段分组和交互文档
- ✅ 一致的UI设计语言和交互模式
- ✅ 向后兼容，保持现有功能不变

---

## 📝 文件变更

### 修改的文件
- `config.py` - 版本号更新为1.7.0
- `fitanalysis.spec` - 版本号更新为1.7.0
- `agent.md` - 新增Section 6.2字段选择器组件设计，更新Section 14版本历史
- `frontend/js/charts.js` - 字段分组配置和选择器重构（+250行）
- `frontend/js/app.js` - 单圈字段选择器和表格动态渲染（+150行）
- `frontend/index.html` - 单圈选择器容器（+2行）
- `frontend/css/styles.css` - 字段选择器样式（+85行）

### 新增的文件
- `RELEASE_CHECKLIST_v1.7.0.md` - 发布检查清单
- `RELEASE_v1.7.0.md` - 版本发布说明（本文档）

---

## 🎯 用户体验提升

### 单圈数据
- ✅ 列数可控，避免列过多或过少
- ✅ 支持IQ字段显示
- ✅ 相对时间更直观

### 字段选择器
- ✅ 字段分组提高查找效率
- ✅ 展开/折叠减少视觉干扰
- ✅ 全选/全不选提高操作效率
- ✅ 选择持久化避免重复操作
- ✅ 空值过滤避免无意义字段

---

## 🔄 向后兼容性

- ✅ 保持所有现有功能不变
- ✅ 导出功能无影响
- ✅ 多活动对比功能无影响
- ✅ 无localStorage保存时使用默认值

---

## 🧪 测试建议

### 功能测试
1. **字段分组显示**
   - [ ] 标准字段正确分组
   - [ ] IQ字段正确分组
   - [ ] 未分类IQ字段自动归类

2. **分组交互**
   - [ ] 点击分组标题展开/折叠
   - [ ] "展开/折叠全部"按钮正常工作
   - [ ] 分组默认全部展开

3. **控制按钮**
   - [ ] "全选"按钮勾选所有字段
   - [ ] "全不选"按钮取消所有勾选

4. **字段选择持久化**
   - [ ] 趋势图字段选择自动保存
   - [ ] 单圈字段选择自动保存
   - [ ] 刷新页面后选择恢复
   - [ ] 无保存数据时使用默认值

5. **空值过滤**
   - [ ] 100%为空的字段不显示
   - [ ] 部分为空的字段正常显示

6. **单圈表格**
   - [ ] 动态列正确生成
   - [ ] 相对时间格式正确
   - [ ] IQ字段值正确显示
   - [ ] 格式化函数正常工作

7. **兼容性**
   - [ ] 导出功能正常
   - [ ] 多活动对比正常
   - [ ] 活动切换时选择正确恢复

### 浏览器测试
- [ ] Chrome
- [ ] Edge
- [ ] Firefox
- [ ] Safari (macOS)

---

## 📦 安装说明

### Windows
1. 解压 `fitanalysis-v1.7.0-windows.zip`
2. 双击运行 `start_server.bat` 或 `fitanalysis.exe`
3. 浏览器自动打开访问 `http://127.0.0.1:8082`

### macOS
1. 解压 `fitanalysis-v1.7.0-macos.zip`
2. 右键点击 `FitAnalysis.app` → "打开"
3. 首次运行需允许未签名应用
4. 浏览器自动打开访问 `http://127.0.0.1:8082`

---

## 🐛 已知问题

无已知问题。

---

## 📮 反馈

如有问题或建议，请通过以下方式反馈：
- GitHub Issues
- 项目维护者邮箱

---

**感谢使用 FIT Running Data Analyzer!**
